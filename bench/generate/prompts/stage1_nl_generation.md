# Stage 1: 自然语言指令生成 (NL Instruction Generation)

## 🎯 你要做什么？

你是一个**真实场景模拟专家**。你的任务是**生成完整的自然语言记忆操作指令**，模拟真实用户在各种场景下使用 Text2Mem 记忆系统的行为。

**重要**：这个阶段**只生成自然语言指令**，不涉及 IR Schema 或技术实现细节。

---

## 📋 核心任务

根据给定的场景配置，生成 **{count}** 条 **{operation}** 操作的自然语言指令。

每条指令需要：

1. ✅ **完整的自然语言表达** – 用户会怎么说
2. ✅ **事实性内容** – 具体的文本、数据、信息（融入在指令中）
3. ✅ **三分类标注** – instruction / structure / lang
4. ✅ **场景和风格标注** – 场景类型、表达风格、主题
5. ✅ **明确操作类型** – 必须指定操作类型，确保生成结果与目标操作匹配

**不需要**：

* ❌ 不需要生成 IR Schema
* ❌ 不需要详细的时间地点人物（这些在 Stage 2 处理）
* ❌ 不要过度结构化的上下文信息

---

## 🌍 场景配置

### 当前场景: {scenario}

**场景描述**: {scenario_description}
**语言**: {lang}

---

## 🎮 目标操作类型

### 当前操作: {operation}

**操作名称**: {operation_name}
**操作描述**: {operation_description}

**常见表达方式**:
{operation_expressions}

---

## 📊 Text2Mem 支持的12种操作

生成指令时，你必须了解以下12种操作类型，确保生成的指令与 **{operation}** 操作匹配：

### 写入操作 (ENC阶段)
1. **Encode（编码/记录）** - 将新内容保存到记忆系统
   - 表达：记录、保存、录入、登记、存储
   - 示例："记录今天的会议纪要"、"保存这个API设计文档"

### 存储管理操作 (STO阶段)
2. **Label（标记/分类）** - 为记录添加或修改标签
   - 表达：标记、打标签、分类、归类
   - 示例："把这条记录标记为重要"、"给文档打上'技术债务'标签"

3. **Update（更新/修改）** - 更新记录的字段或属性
   - 表达：更新、修改、调整、变更
   - 示例："更新项目状态为已完成"、"修改客户的联系方式"

4. **Promote（提升/强调）** - 提升记录优先级或设置提醒
   - 表达：提升优先级、标记重要、设置提醒
   - 示例："把这个任务提升为高优先级"、"设置每周提醒"

5. **Demote（降级/归档）** - 降低记录优先级或归档
   - 表达：归档、降级、降低优先级
   - 示例："把旧的会议记录归档"、"降低这个任务的优先级"

6. **Merge（合并）** - 合并多条相关记录
   - 表达：合并、整合、链接、汇总
   - 示例："把这三条重复的客户信息合并"、"整合所有关于项目A的讨论"

7. **Split（拆分）** - 将一条记录拆分为多条
   - 表达：拆分、分离、分解、切分
   - 示例："把这个长文档拆分成多个章节"、"将混合内容分离开"

8. **Lock（锁定/保护）** - 锁定记录防止修改
   - 表达：锁定、保护、设为只读、冻结
   - 示例："锁定事件时间线，不允许修改"、"保护这份财务数据"

9. **Expire（过期/生命周期）** - 设置记录的过期时间
   - 表达：设置过期、定时清理、保留到某时间
   - 示例："设置临时文件30天后过期"、"这些数据保留到季度末"

10. **Delete（删除/移除）** - 删除不需要的记录
    - 表达：删除、移除、清理、删掉
    - 示例："删除所有过期的测试数据"、"清理重复的记录"

### 检索操作 (RET阶段)
11. **Retrieve（检索/查找）** - 从记忆系统检索相关内容
    - 表达：查找、检索、搜索、查询
    - 示例："查找上个月关于API设计的讨论"、"搜索所有标记为紧急的任务"

12. **Summarize（总结/摘要）** - 生成记录的摘要
    - 表达：总结、生成摘要、概括、提炼
    - 示例："总结本季度的销售会议内容"、"生成投资人更新的执行摘要"

**⚠️ 关键要求**：你生成的每条指令的 `scenario_info.operation` 字段**必须**填写为 **{operation}**，不能填写其他操作类型！

---

## 🎨 多样化要求

### 1. 事实性内容融入指令

每条指令应**自然地包含**具体事实内容，可来自文本、音频、结构化数据或即时想法。

为增强多样性，可混合以下类型：

**📝 文本内容**

* “记录今天学到的 Transformer 三个核心概念：自注意力、位置编码、多头注意力。”
* “把刚才那段 API 设计文档存一下，重点是 RESTful 接口规范那部分。”

**🎙️ 音频转录**

* “整理刚才的会议录音，重点是 Q4 产品路线图的三个方向。”
* “保存一下语音备忘录：支付成功率要提升到 99%，时延降到 100 ms 以内。”

**📊 结构化数据**

* “记下今天的健身记录：卧推 4 组× 8 次，重量 185 磅。”
* “存一下购物清单：橙子 3 斤、牛奶 2 瓶、面包 1 袋。”

**🔗 引用来源**

* “找一下上周读的那篇 Google Spanner 论文笔记。”
* “查找《深度学习》第 8 章关于优化算法的要点。”

**💭 思考与创意**

* “在咖啡厅想到的那个小说开头存一下，关于时间旅行的。”
* “记录这个灵感：用区块链解决供应链溯源问题。”

**📨 通信或任务指令**

* “把和 Alice 关于 API 测试的聊天内容存起来，方便后续回看。”
* “请保存这封客户反馈邮件，主题是‘报价方案 V3 确认’。”

---

### 2. context 真实性与长度要求 （强化）⭐

`context` 必须是真实原始输入，模拟系统接收到的自然内容。为确保真实性与多样性：

**长度要求**：
* **最少 {min_context_length} 字**
* **推荐 {context_length_range} 字**
* **最多 {max_context_length} 字**
* ⚠️ **严格禁止**短于 {min_context_length} 字的context

**内容特征**：
* **保留噪声与口语**（语气词、省略、打断、格式符）
* **来源类型** 随机选择：

| 类型   | 示例标签     | 内容特征          | 推荐长度 |
| ---- | -------- | ------------- | ---- |
| 录音转写 | `[录音转写]` | 多人发言、口语、重复、打断 | 150-300字 |
| 邮件原文 | `[邮件原文]` | 包含署名、时间、问候    | 120-250字 |
| 文档片段 | `[文档原文]` | 段落、标题、引用符号    | 150-350字 |
| 聊天记录 | `[聊天记录]` | 多轮消息、时间戳、表情   | 100-200字 |
| 笔记草稿 | `[笔记原文]` | 未整理句、缩略语      | 120-280字 |
| 数据导出 | `[数据导出]` | 表格、字段名、半结构化内容 | 100-250字 |

**示例（正确 - 220字）**

```json
"context": "[录音转写] 王经理：呃……Q4我们得重点推进支付系统重构，预算大概两百万吧，周期——两个月？技术总监：对，不过接口兼容性得先评估，尤其是老系统那边。运营部：上线要配合新活动节奏，不能影响双十一大促。王经理：明白，那我们先做技术评估，下周三给我个详细方案。对了，安全团队也得介入，这次要过PCI DSS认证。技术总监：没问题，我安排架构师这周出个设计文档。嗯……还有个问题，现在的数据库扛不扛得住？DBA：目前QPS是8000左右，重构后预估会翻倍，建议提前做容量规划。"
```

**示例（错误 - 仅23字）**

```json
"context": "会议讨论了Q4的产品规划和预算。"
```

---

### 3. instruction 与 context 内容的关联性

每条 instruction 必须引用 context 中的某个细节（如数字、项目名、关键词）。
例如：

> 若 context 提到“支付系统重构、预算 200 万”，则 instruction 需出现“预算”或“支付系统”。

这样保证自然指令与输入内容语义一致。

---

### 4. 语言表达多样性

指令应覆盖不同语气与句式：

* **casual** – 随意口语

  * “存一下，回头再看。”
* **formal** – 正式专业

  * “请将本次评审的关键决策内容存档。”
* **question** – 疑问语气

  * “能帮我保存昨天的会议纪要吗？”
* **command** – 命令语气

  * “记录下来，这个很重要。”

可适度加入自然语气词（“呃”“嗯”“好吧”）、中英混用（如 KPI、deadline）或轻微省略，以提高人类语感。

---

### 5. 结构复杂度 (structure) 的自然语言表达 ⭐

**非常重要**：只有两种结构类型，指令的自然语言表达必须与 `structure` 分类匹配！

**注意**：本批次需要生成的 single 和 workflow **具体数量由计划配置决定**，将在"本批次结构要求"部分明确指定。

#### single（单一操作）
- **特点**：只涉及一个明确的操作请求
- **适用**：绝大多数日常场景
- **自然语言特征**：简洁、直接、单一动作
- **示例**：
  - "记录今天的客户会议纪要。"
  - "查找上周关于API设计的讨论。"
  - "把这份文档标记为重要。"
  - "总结本季度的销售数据。"
  - "更新项目状态为已完成。"
  - "删除所有过期的测试数据。"

#### workflow（多步骤操作流程）
- **特点**：
  - ⚠️ **用户在一句话中表达了多个连续的操作需求**
  - ⚠️ **有明确的步骤顺序**（"先...再...""然后""接着""最后"）
  - ⚠️ **体现完整的任务流程**，不是简单的两步
  
- **关键词识别**：
  - 明确步骤："首先...然后...最后"、"第一步...第二步...第三步"
  - 顺序连接："先...再...接着...最后"、"完成X之后，再Y，最后Z"
  - 流程描述："一边...一边..."、"做完...之后，顺便..."
  
- **自然场景示例**（workflow）：
  
  1. **完整处理流程**：
     - "把这次事故的分析报告记录下来，**然后**生成一份高管摘要，**最后**锁定这些记录别让人改。" ✅
     - "**先**把所有客户反馈找出来，**再**整合成一份文档，**接着**标记为Q4重点，**最后**设置每周提醒我看。" ✅
  
  2. **归档清理流程**：
     - "把旧项目的文档都归档了，**顺便**降低它们的优先级，**最后**设置半年后自动删除。" ✅
     - "清理一下测试数据，**先**删除过期的，**然后**把剩下的重新分类打标签。" ✅
  
  3. **记录后处理**：
     - "记录这次会议内容，**完成后**给重要部分打上标签，**然后**提升优先级，**最后**设置明天提醒。" ✅
     - "把这份合同存档，**同时**标记为重要客户，**并且**锁定不让修改，**最后**添加到年度审计列表。" ✅
  
  4. **检索后操作**：
     - "找出所有关于项目A的记录，**然后**合并成一个总结，**接着**更新项目状态，**最后**通知团队。" ✅
     - "查一下去年的预算数据，**整理后**生成对比报告，**再**标记为财务重点。" ✅

- **非workflow示例**（这些是single）：
  - "记录会议内容并标记为重要。" ❌ 只有2步，不够
  - "查找客户反馈然后生成摘要。" ❌ 只有2步
  - "更新状态，同时通知相关人员。" ❌ 只有2步，太简单
  - "保存这个文档，打上标签。" ❌ 只有2步

**判断标准**：
- **single**：指令中只有1个明确的操作请求（即使操作本身可能很复杂）
- **workflow**：指令中包含**3个或更多步骤**，有明确的执行顺序，体现完整流程

**数量要求**：
- 具体的 single 和 workflow 数量**由计划配置的 characteristics.structure 比例自动分配**
- 每个批次的具体数量会在"本批次结构要求"中明确说明
- 请严格按照指定数量生成，不多不少

**自然语言特征对比**：
```
Single:  "记录今天的会议内容。"
         "查找所有客户反馈。"
         "把文档标记为重要并归档。" （2步，仍是single）

Workflow: "先记录会议内容，再生成摘要，然后标记重要部分，最后设置提醒。"
          "把客户反馈都找出来，整合成报告，标记优先级，设置每周复审。"
```

**⚠️ 重要提示**：
- workflow的自然语言必须**明确体现多个步骤**，不能是简单的"记录并标记"
- 在context中，workflow指令对应的原始内容往往也更复杂、更完整

**生成提示**：
当需要生成workflow样本时：
1. instruction必须包含明确的步骤词（"先...再...然后...最后"）
2. context应该包含支持多步骤操作的复杂内容
3. 每个步骤应该是不同类型的操作（记录→整理→标记→提醒）
4. 整体体现一个完整的业务流程或任务链

---

## ⚙️ 三分类标注

#### instruction_type

* **direct** – 明确直白："记录这个会议纪要"
* **indirect** – 含蓄暗示："把刚才讨论的内容存一下"

#### structure

* **single** – 单一操作
  - 指令中只有1个操作请求
  - 即使描述复杂，但核心只做一件事
  - 例："记录会议内容并标记为重要"（虽有"并"，但仍是单一记录任务）

* **workflow** – 多步骤流程
  - 指令中明确包含**3个或更多连续步骤**
  - 必须有顺序关键词："先...再...然后...最后"
  - 体现完整的任务链或业务流程
  - 例："先记录会议内容，再生成摘要，然后标记重点，最后设置提醒"

**⚠️ 注意**：本批次的 single 和 workflow 数量**由计划配置自动分配**，会在"本批次结构要求"部分明确说明，请严格遵守。

#### lang

* **zh** – 中文
* **en** – 英文

---

## 📤 输出格式

⚠️ **必须直接输出合法 JSON Array，不包含任何解释或附加文字。**

```json
[
  {
    "instruction": "完整的自然语言指令，用户会怎么说这句话",
    "context": "原始输入内容（{context_length_range}字，必须≥{min_context_length}字）",
    "classification": {
      "instruction_type": "direct|indirect",
      "structure": "single|workflow",
      "lang": "zh|en"
    },
    "scenario_info": {
      "scenario": "{scenario}",
      "operation": "{operation}",
      "style": "casual|formal|question|command",
      "topic": "简短的主题描述（5-10字）"
    }
  }
]
```

**关键字段说明**：

1. **instruction** - 完整的自然语言表达，必须包含具体内容
   - workflow类型必须明确包含步骤词："先...再...然后...最后"
   
2. **context** - 原始输入内容，长度必须在 {context_length_range} 字之间，严格≥{min_context_length}字
   - workflow对应的context往往更复杂、更完整
   
3. **classification.structure** - 必须根据instruction准确分类：
   - **single**: 单一操作请求，即使复杂但只做一件事
   - **workflow**: 明确的3+步骤流程，有顺序关键词（"先...再...然后...最后"）
   - **注意**：数量由计划配置的 characteristics.structure 比例决定，具体要求见"本批次结构要求"
   
4. **scenario_info.operation** - ⚠️ **必须填写为 "{operation}"**，不能填写其他操作类型！

---

## ✅ 输出要求

1. **自然语言真实流畅**，贴合用户口语或书面表达。
2. **context 必须为原始输入**，保留噪声与细节，长度≥{min_context_length}字。
3. **classification 完整、准确**，structure分类必须匹配instruction表达。
4. **scenario_info.operation 必须为 "{operation}"**。
5. **场景与风格多样化**（不同语气、不同内容类型）。
6. **输出为合法 JSON Array，无其他文字**。

---

## 🚫 严格禁止

* ❌ 输出任何说明或附加文字。
* ❌ 将 context 摘要化或改写，或生成短于{min_context_length}字的context。
* ❌ 输出不合法或格式错误的 JSON。
* ❌ scenario_info.operation 字段填写非 "{operation}" 的其他操作类型。

---

## 🎬 最终生成指令

请根据以下参数生成 **{count}** 条高质量自然语言指令样本：

* **operation**: `{operation}` （⚠️ 所有样本的 scenario_info.operation 必须为此值）
* **operation_name**: `{operation_name}`
* **operation_description**: `{operation_description}`
* **scenario**: `{scenario}`
* **language**: `{lang}`
* **count**: `{count}`
* **context_length**: {context_length_range} 字（最少{min_context_length}字）

输出格式：
👉 **仅输出合法 JSON Array，无任何额外文本或说明。**
