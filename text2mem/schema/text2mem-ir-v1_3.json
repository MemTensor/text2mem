{
  "title": "Text2Mem IR v1.3",
  "type": "object",
  "additionalProperties": false,
  "required": ["stage", "op"],
  "properties": {
    "stage": { "type": "string", "enum": ["ENC", "STO", "RET"] },
    "op": { "$ref": "#/$defs/Op" },
    "target": { "$ref": "#/$defs/TargetSpec" },
    "args": { "type": "object" },
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "actor": { "type": "string" },
        "lang": { "type": "string" },
        "trace_id": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" },
        "dry_run": { "type": "boolean", "default": false }
      }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "op": { "const": "Encode" } }, "required": ["op"] },
      "then": {
        "properties": {
          "stage": { "const": "ENC" },
          "args": {
            "type": "object",
            "required": ["payload"],
            "additionalProperties": false,
            "properties": {
              "payload": {
                "type": "object",
                "oneOf": [
                  { "required": ["text"] },
                  { "required": ["url"] },
                  { "required": ["structured"] }
                ],
                "properties": {
                  "text": { "type": "string" },
                  "url": { "type": "string", "format": "uri" },
                  "structured": { "type": "object" }
                },
                "additionalProperties": true
              },
              "type": { "$ref": "#/$defs/Type" },
              "tags": { "$ref": "#/$defs/Tags" },
              "facets": { "$ref": "#/$defs/Facets" },
              "time": { "type": "string", "format": "date-time" },
              "subject": { "type": "string" },
              "location": { "type": "string" },
              "topic": { "type": "string" },
              "embedding": { "$ref": "#/$defs/Embedding" },
              "use_embedding": { "type": "boolean", "default": false },
              "source": { "type": "string" },
              "priority": { "$ref": "#/$defs/Priority" },
              "auto_frequency": { "type": "string", "description": "ISO8601 duration or RRULE" },
              "expire_at": { "type": "string", "format": "date-time" },
              "next_auto_update_at": { "type": "string", "format": "date-time" },
              "read_perm_level": { "$ref": "#/$defs/ReadPerm" },
              "write_perm_level": { "$ref": "#/$defs/WritePerm" },
              "read_whitelist": { "$ref": "#/$defs/IdList" },
              "read_blacklist": { "$ref": "#/$defs/IdList" },
              "write_whitelist": { "$ref": "#/$defs/IdList" },
              "write_blacklist": { "$ref": "#/$defs/IdList" }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Label" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "enum": ["ENC", "STO"] },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "anyOf": [
              { "required": ["tags"] },
              { "required": ["facets"] }
            ],
            "properties": {
              "tags": { "$ref": "#/$defs/Tags" },
              "facets": { "$ref": "#/$defs/Facets" }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Update" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "required": ["set"],
            "additionalProperties": false,
            "properties": {
              "set": {
                "type": "object",
                "additionalProperties": false,
                "minProperties": 1,
                "properties": {
                  "text": { "type": "string" },
                  "time": { "type": "string", "format": "date-time" },
                  "type": { "$ref": "#/$defs/Type" },
                  "ttl": { "$ref": "#/$defs/ISO8601Duration" },
                  "priority": { "$ref": "#/$defs/Priority" },
                  "weight": { "type": "number" },
                  "subject": { "type": "string" },
                  "location": { "type": "string" },
                  "topic": { "type": "string" },
                  "facets": { "$ref": "#/$defs/Facets" },
                  "embedding": { "$ref": "#/$defs/Embedding" },
                  "auto_frequency": { "type": "string" },
                  "expire_at": { "type": "string", "format": "date-time" },
                  "next_auto_update_at": { "type": "string", "format": "date-time" },
                  "read_perm_level": { "$ref": "#/$defs/ReadPerm" },
                  "write_perm_level": { "$ref": "#/$defs/WritePerm" },
                  "read_whitelist": { "$ref": "#/$defs/IdList" },
                  "read_blacklist": { "$ref": "#/$defs/IdList" },
                  "write_whitelist": { "$ref": "#/$defs/IdList" },
                  "write_blacklist": { "$ref": "#/$defs/IdList" }
                }
              }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Merge" } }, "required": ["op"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "strategy": {
                "type": "string",
                "enum": ["link_and_keep","fold_into_primary"],
                "default": "fold_into_primary"
              },
              "primary_id": { "type": "string" },
              "soft_delete_children": { "type": "boolean", "default": true }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Promote" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "oneOf": [
              { "required": ["priority"] },
              { "required": ["weight_delta"] },
              { "required": ["remind"] }
            ],
            "properties": {
              "priority": { "$ref": "#/$defs/Priority" },
              "weight_delta": { "type": "number" },
              "remind": {
                "type": "object",
                "required": ["rrule"],
                "additionalProperties": false,
                "properties": {
                  "rrule": { "type": "string", "description": "RFC5545 RRULE" },
                  "until": { "type": "string", "format": "date-time" }
                }
              }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Demote" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "archive": { "type": "boolean" },
              "priority": { "$ref": "#/$defs/Priority" },
              "weight_delta": { "type": "number" }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Delete" } }, "required": ["op"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "older_than": { "$ref": "#/$defs/ISO8601Duration" },
              "time_range": { "$ref": "#/$defs/TimeRange" },
              "soft": { "type": "boolean", "default": true },
              "reason": { "type": "string" }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Retrieve" } }, "required": ["op"] },
      "then": {
        "properties": {
          "stage": { "const": "RET" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "query": { "type": "string" },
              "time_range": { "$ref": "#/$defs/TimeRange" },
              "k": { "type": "integer", "minimum": 1, "default": 10 },
              "order_by": {
                "type": "string",
                "enum": ["relevance","time_desc","time_asc","priority_desc"],
                "default": "relevance"
              },
              "include": { "$ref": "#/$defs/IncludeList" }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Summarize" } }, "required": ["op"] },
      "then": {
        "properties": {
          "stage": { "enum": ["STO","RET"] },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "focus": { "type": "string" },
              "max_tokens": { "type": "integer", "minimum": 1, "default": 256 },
              "time_range": { "$ref": "#/$defs/TimeRange" }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Split" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "enum": ["ENC","STO"] },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "strategy": {
                "type": "string",
                "enum": ["auto_by_patterns","headings","sentences","custom_spans"],
                "default": "auto_by_patterns"
              },
              "spans": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["start","end"],
                  "additionalProperties": false,
                  "properties": {
                    "start": { "type": "integer", "minimum": 0 },
                    "end": { "type": "integer", "minimum": 0 }
                  }
                }
              },
              "inherit": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "tags": { "type": "boolean", "default": true },
                  "time": { "type": "boolean", "default": true },
                  "source": { "type": "boolean", "default": true }
                }
              },
              "link_back": {
                "type": "string",
                "enum": ["none","bi_directional"],
                "default": "bi_directional"
              }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Lock" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "mode": {
                "type": "string",
                "enum": ["read_only","append_only"],
                "default": "read_only"
              },
              "reason": { "type": "string" },
              "policy": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "allow": { "type": "array", "items": { "$ref": "#/$defs/Op" } },
                  "deny": { "type": "array", "items": { "$ref": "#/$defs/Op" } },
                  "reviewers": { "$ref": "#/$defs/IdList" },
                  "expires": { "type": "string", "format": "date-time" }
                }
              }
            }
          }
        }
      }
    },

    {
      "if": { "properties": { "op": { "const": "Expire" } }, "required": ["op","target"] },
      "then": {
        "properties": {
          "stage": { "const": "STO" },
          "args": {
            "type": "object",
            "additionalProperties": false,
            "oneOf": [
              { "required": ["ttl"] },
              { "required": ["until"] }
            ],
            "properties": {
              "ttl": { "$ref": "#/$defs/ISO8601Duration" },
              "until": { "type": "string", "format": "date-time" },
              "on_expire": {
                "type": "string",
                "enum": ["soft_delete","hard_delete","demote","anonymize"],
                "default": "soft_delete"
              }
            }
          }
        }
      }
    }
  ],

  "$defs": {
    "Op": {
      "type": "string",
      "enum": [
        "Encode","Label","Update","Merge","Promote","Demote","Delete",
        "Retrieve","Summarize","Split","Lock","Expire"
      ]
    },
    "Type": {
      "type": "string",
      "enum": ["note","event","task","profile","preference","generic"]
    },
    "Priority": {
      "type": "string",
      "enum": ["low","normal","high","urgent"],
      "description": "建议映射：low=0, normal=1, high=2, urgent=3"
    },
    "Embedding": {
      "type": "array",
      "items": { "type": "number" },
      "minItems": 1,
      "description": "可选；向量长度不强约束，以适配不同模型"
    },
    "Tags": {
      "type": "array",
      "items": { "type": "string" },
      "uniqueItems": true
    },
    "Facets": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "subject": { "type": "string" },
        "time": { "type": "string", "format": "date-time" },
        "location": { "type": "string" },
        "topic": { "type": "string" }
      }
    },
    "ReadPerm": {
      "type": "string",
      "enum": ["public","team","private","custom"]
    },
    "WritePerm": {
      "type": "string",
      "enum": ["open","maintainer","owner_only","custom"]
    },
    "IdList": {
      "type": "array",
      "items": { "type": "string" },
      "uniqueItems": true
    },
    "TimeRange": {
      "type": "object",
      "additionalProperties": false,
      "oneOf": [
        { "required": ["start","end"] },
        { "required": ["relative","amount","unit"] }
      ],
      "properties": {
        "start": { "type": "string", "format": "date-time" },
        "end": { "type": "string", "format": "date-time" },
        "relative": { "type": "string", "enum": ["last","next"] },
        "amount": { "type": "integer", "minimum": 1 },
        "unit": { "type": "string", "enum": ["minutes","hours","days","weeks","months","years"] }
      }
    },
    "ISO8601Duration": {
      "type": "string",
      "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+S)?)?$",
      "description": "ISO8601 duration, e.g., P3D, PT1H30M"
    },
    "IncludeList": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "id","text","type","tags","facets","time","subject","location","topic",
          "source","priority","weight",
          "read_perm_level","write_perm_level",
          "read_whitelist","read_blacklist","write_whitelist","write_blacklist"
        ]
      },
      "uniqueItems": true
    },
    "Filters": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "time_range": { "$ref": "#/$defs/TimeRange" },
        "has_tags": { "$ref": "#/$defs/Tags" },
        "not_tags": { "$ref": "#/$defs/Tags" },
        "type": { "$ref": "#/$defs/Type" },
        "limit": { "type": "integer", "minimum": 1 }
      }
    },
    "TargetSpec": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "by_id": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" }, "uniqueItems": true }
          ]
        },
        "by_tags": { "$ref": "#/$defs/Tags" },
        "match": { "type": "string", "enum": ["any","all"], "default": "any" },
        "by_query": { "type": "string" },
        "topic": { "type": "string" },
        "all": { "type": "boolean", "default": false },
        "filters": { "$ref": "#/$defs/Filters" }
      }
    }
  }
}
